@page "/"
<Sliding />
<div class="wordle-app">
    <div id="wordle-announcer" class="wordle-sr-only" aria-live="polite" aria-atomic="true">@announcementText</div>
    <header class="wordle-header @(isDailyMode && !string.IsNullOrEmpty(nextWordIn) ? "wordle-header-with-countdown" : "")">
        <h1 class="wordle-title">WORDLE</h1>
        @if (isDailyMode && !string.IsNullOrEmpty(nextWordIn))
        {
            <p class="wordle-next-word-in" aria-live="polite">Next word in @nextWordIn</p>
        }
        <div class="wordle-header-actions">
            <label class="wordle-daily-toggle" title="Daily word (same word for everyone today)">
                <input type="checkbox" checked="@isDailyMode" @onchange="@(e => ToggleDailyMode(e))" />
                <span>Daily</span>
            </label>
            @if (isHardMode)
            {
                <span class="wordle-hard-badge" title="Hard mode: use revealed letters">Hard</span>
            }
            <button type="button" class="wordle-icon-btn" aria-label="@(theme == "dark" ? "Switch to light mode" : "Switch to dark mode")" @onclick="ToggleThemeAsync" title="@(theme == "dark" ? "Light mode" : "Dark mode")">@(theme == "dark" ? "‚òÄÔ∏è" : "üåô")</button>
            <button type="button" class="wordle-icon-btn" aria-label="Statistics" @onclick="OpenStatsModalAsync">üìä</button>
            <button type="button" class="wordle-icon-btn" aria-label="How to play" @onclick="HelpDialog">?</button>
            <button type="button" class="wordle-icon-btn" aria-label="Settings" @onclick="OpenSettingsModalAsync">‚öôÔ∏è</button>
        </div>
    </header>
    <main class="wordle-main">
        <div class="wordle-grid">
            @for (var rowIndex = 0; rowIndex < list.Count; rowIndex++)
            {
                var row = list[rowIndex];
                <div class="@RowCssClass(rowIndex)">
                    @for (var colIndex = 0; colIndex < row.Count; colIndex++)
                    {
                        var point = row[colIndex];
                        <div class="@TileCssClass(rowIndex, colIndex) @point.GetStateClass()" style="@(string.IsNullOrEmpty(point.GetStateClass()) ? "background-color:" + point.GetBackGroundColor() + "; color:" + point.GetTextColor() + "; " : "")border-color:@(point.PlaceHolder == ' ' || Config.CurrentIndex == point.Row ? BorderColor : "transparent");">
                            <span class="wordle-tile-letter" style="@(string.IsNullOrEmpty(point.GetStateClass()) ? "color:" + point.GetTextColor() : "");">@point.PlaceHolderToString()</span>
                        </div>
                    }
                </div>
            }
        </div>
        <div class="wordle-keyboard">
            <div class="wordle-keyrow">
                @foreach (var item in alphabet[0])
                {
                    var keyClass = hashOfCharacter.ContainsKey(item) ? Config.GetKeyBoardClass(hashOfCharacter[item]) : "";
                    <button type="button" class="wordle-key @keyClass" style="@(string.IsNullOrEmpty(keyClass) ? KeyStyleDefault : "")" @onclick='() => OnArrowKeyPressed(item.ToString())'>@item.ToString().ToUpper()</button>
                }
            </div>
            <div class="wordle-keyrow">
                <div class="wordle-key-spacer"></div>
                @foreach (var item in alphabet[1])
                {
                    var keyClass1 = hashOfCharacter.ContainsKey(item) ? Config.GetKeyBoardClass(hashOfCharacter[item]) : "";
                    <button type="button" class="wordle-key @keyClass1" style="@(string.IsNullOrEmpty(keyClass1) ? KeyStyleDefault : "")" @onclick='() => OnArrowKeyPressed(item.ToString())'>@item.ToString().ToUpper()</button>
                }
                <div class="wordle-key-spacer"></div>
            </div>
            <div class="wordle-keyrow">
                <button type="button" class="wordle-key wordle-key-wide" style="@KeyStyleDefault" @onclick='() => OnArrowKeyPressed("Enter")'>ENTER</button>
                @foreach (var item in alphabet[2])
                {
                    var keyClass2 = hashOfCharacter.ContainsKey(item) ? Config.GetKeyBoardClass(hashOfCharacter[item]) : "";
                    <button type="button" class="wordle-key @keyClass2" style="@(string.IsNullOrEmpty(keyClass2) ? KeyStyleDefault : "")" @onclick='() => OnArrowKeyPressed(item.ToString())'>@item.ToString().ToUpper()</button>
                }
                <button type="button" class="wordle-key wordle-key-wide" style="@KeyStyleDefault" @onclick='() => OnArrowKeyPressed("Backspace")'>‚å´</button>
            </div>
        </div>
    </main>
</div>

@if (showLostModal)
{
    <Modal IsOpen="true" Title="CORRECT WORD" OnClose="CloseLostModal">
        <LostScreen OnClose="CloseLostModal" />
    </Modal>
}
@if (showHowToPlayModal)
{
    <Modal IsOpen="true" Title="HOW TO PLAY" OnClose="CloseHowToPlayModal">
        <HowToPlay OnClose="CloseHowToPlayModal" />
    </Modal>
}

@if (showWinModal)
{
    <Modal IsOpen="true" Title="YOU GOT IT!" OnClose="CloseWinModal">
        <div class="win-modal-content" style="color: var(--outline-dark);">
            <p class="win-guess-line">Solved in <strong>@(winGuessCount ?? 0)</strong> guess@(winGuessCount == 1 ? "" : "es")!</p>
            <div class="flex gap-2 mt-4">
                <button type="button" class="wordle-btn-primary py-2 px-4 rounded font-semibold flex-1" @onclick="CopyShareAsync">
                    @(shareCopied ? "Copied!" : "Share")
                </button>
                <button type="button" class="wordle-btn-primary py-2 px-4 rounded font-semibold flex-1" @onclick="Submit">Play again</button>
            </div>
        </div>
    </Modal>
}

@if (showSettingsModal)
{
    <Modal IsOpen="true" Title="SETTINGS" OnClose="CloseSettingsModal">
        <Settings Theme="@theme" Palette="@palette" HardMode="@isHardMode" SoundOn="@soundOn" HapticsOn="@hapticsOn" ReduceMotion="@reduceMotion"
                  OnClose="CloseSettingsModal" OnThemeChange="RefreshThemeAsync" OnPaletteChange="RefreshPaletteAsync"
                  OnHardModeChange="RefreshHardModeAsync" OnSoundChange="RefreshSoundAsync" OnHapticsChange="RefreshHapticsAsync" OnReduceMotionChange="RefreshReduceMotionAsync" />
    </Modal>
}
@if (showStatsModal)
{
    <Modal IsOpen="true" Title="STATS" OnClose="CloseStatsModal">
        <div class="stats-modal-content">
            <div class="stats-grid">
                <div class="stats-box">
                    <div class="stats-box-value">@(stats?.Played ?? 0)</div>
                    <div class="stats-box-label">Played</div>
                </div>
                <div class="stats-box">
                    <div class="stats-box-value">@(stats?.Wins > 0 && stats?.Played > 0 ? (stats.Wins * 100 / stats.Played).ToString("0") + "%" : "0%")</div>
                    <div class="stats-box-label">Win %</div>
                </div>
                <div class="stats-box">
                    <div class="stats-box-value">@(stats?.Streak ?? 0)</div>
                    <div class="stats-box-label">Streak</div>
                </div>
                <div class="stats-box">
                    <div class="stats-box-value">@(stats?.MaxStreak ?? 0)</div>
                    <div class="stats-box-label">Best</div>
                </div>
            </div>
            <div class="stats-distribution">
                <p class="stats-dist-title" style="font-weight:700;margin-bottom:0.5rem;color:var(--outline-dark);">Guess distribution</p>
                @for (var i = 0; i < 6; i++)
                {
                    var count = stats?.Distribution != null && i < stats.Distribution.Length ? stats.Distribution[i] : 0;
                    var max = (stats?.Distribution?.Max() ?? 1);
                    var pct = max > 0 ? (count * 100.0 / max) : 0;
                    <div class="stats-dist-row">
                        <span class="stats-dist-num">@(i + 1)</span>
                        <div class="stats-dist-bar-wrap">
                            <div class="stats-dist-bar" style="width: @(pct)%"></div>
                        </div>
                        <span style="min-width:1.5rem;font-weight:600;color:var(--outline-dark);">@count</span>
                    </div>
                }
            </div>
        </div>
    </Modal>
}

@code {
    private async Task CloseHowToPlayModal()
    {
        try { await JSRuntime.InvokeVoidAsync("wordleRestoreFocus"); } catch { }
        showHowToPlayModal = false;
        StateHasChanged();
    }

    private async Task CloseWinModal()
    {
        try { await JSRuntime.InvokeVoidAsync("wordleRestoreFocus"); } catch { }
        showWinModal = false;
        StateHasChanged();
    }

    private void Submit()
    {
        showWinModal = false;
        Reset();
        StateHasChanged();
    }

    private void ToggleDailyMode()
    {
        Reset();
        StateHasChanged();
    }
}
